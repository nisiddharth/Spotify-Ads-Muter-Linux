#!/bin/bash
# Script to respawn or mute an application using PulseAudio, depending solely on
# process name, constructed as answer on askubuntu.com:.
# http://askubuntu.com/questions/180612/script-to-mute-an-application

# It works as: mute_application.sh vlc mute OR mute_application.sh vlc unmute

if [ -z "$1" ]; then
    echo "Please provide me with an application name"
    exit 1
fi

if [ -z "$2" ]; then
    echo "Please provide me with an action mute/unmute/respawn after the application name"
    exit 1
fi

if ! [[ "$2" == "mute" || "$2" == "unmute" || "$2" == "respawn" ]]; then
    echo "The 2nd argument must be mute/unmute/respawn"
    exit 1
fi

process_id=$(pidof "$1")

if [ $? -ne 0 ]; then
    echo "There is no such process as "$1""
    exit 1
fi

temp=$(mktemp)

pacmd list-sink-inputs > $temp

inputs_found=0;
current_index=-1;

while read line; do
    if [ $inputs_found -eq 0 ]; then
	    inputs=$(echo -ne "$line" | awk '{print $2}')
	    if [[ "$inputs" == "to" ]]; then
		    continue
	    fi
	    inputs_found=1
    else
	    if [[ "${line:0:6}" == "index:" ]]; then
		    current_index="${line:7}"
	    elif [[ "${line:0:25}" == "application.process.id = " ]]; then
		    if [[ "${line:25}" == "\"$process_id\"" ]]; then
			    # index found...
			    break;
		    fi
	    fi
    fi
done < $temp

rm -f $temp

if [ $current_index -eq -1 ]; then
    echo "Could not find "$1" in the processes that output sound."
    exit 1
fi

# muting, unmuting, or respawning
if [[ "$2" == "mute" ]]; then
    pacmd set-sink-input-mute "$current_index" 1 > /dev/null 2>&1
elif [[ "$2" == "unmute" ]]; then
    pacmd set-sink-input-mute "$current_index" 0 > /dev/null 2>&1
elif [[ "$2" == "respawn" ]]; then
    killall $1 # kill application
    while pgrep -x application >/dev/null; do sleep 1; done # wait for application to die
    $1 # start application
    if [[ "$1" == "spotify" ]]; then
        echo "Waiting for Spotify to start..."
        sleep 8 # wait for application to start
        echo "Spotify started, playing song..."
        xdotool search --name "$1" key space # send spacebar to application window to play song
        echo "Play signal sent to Spotify"
    fi
fi
exit 0
